#!/usr/bin/env ruby

require_relative '../lib/core'
require "tempfile"
require "tmpdir"
require "erb"

LOGGER = Logger.new($stdout)

ROOT_DIR = File.expand_path(File.join(__dir__, '..'))
SITE_DIR = File.join(ROOT_DIR, "docs")

year = Time.now.year
month = Time.now.strftime("%m")
ymd = Time.now.strftime("%Y-%m-%d")

observation_path = File.join(ROOT_DIR, "observations", "#{year}", "#{month}", "#{ymd}.tsv")

observations = []

File.open(observation_path) do |f|
  observations = ObservationsLoader.new(metrics: METRICS).load(f).observations
end

current_conditions = observations.sort_by(&:observed_at).last

# Write the current conditions to index.html
template = File.open(File.join(SITE_DIR, "templates", "index.html.erb")).read

template_locals = {}

current_conditions.each do |key, value|
  template_locals[key] = value
end

template_locals[:ts] = Time.now.to_i
template_locals[:current_datetime] = current_conditions.observed_at.strftime('%Y-%m-%d %H:%M')

rendered = ERB.new(template).result_with_hash(template_locals)

File.open(File.join(SITE_DIR, "index.html"), 'w') do |f|
  f.write(rendered)
end

# Now let's generate a plot of today's temperature

# We need to grab the column index of the value we care about, from this file
header = File.open(observation_path, &:readline).strip.split("\t")
temp_col_index = header.index("temp_f")

Dir.mktmpdir {|dir|
  gp_file_path = File.join(dir, "gnuplot_script.gp")

  gnuplot_script = <<~GNUPLOT
    set terminal pngcairo size 800,400 enhanced font 'Verdana,10'
    set output '#{File.join(SITE_DIR, "images", "temperature_today.png")}'
    set datafile separator '\t'
    set xdata time
    set timefmt "%Y-%m-%d %H:%M"
    set format x "%H:%M"
    set title "Temperature on #{ymd}"
    set xlabel "Time"
    set ylabel "Temperature (°F)"
    set grid
    plot '#{observation_path}' using 1:#{temp_col_index} with lines title 'Temp (°F)'
  GNUPLOT

  puts gnuplot_script

  File.open(gp_file_path, "w") do |gnuplot|
    gnuplot.write(gnuplot_script)
  end

  # Run gnuplot
  cmd = "gnuplot #{gp_file_path}"

  puts "Will run: #{cmd}"

  puts `#{cmd}`
}
